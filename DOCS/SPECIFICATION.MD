# Specification: CV Repository Architecture & CI/CD Pipeline

---

## 1. Project Overview

This repository implements an automated, multilingual, AI-friendly CV generator and publisher, featuring:

- Centralized markdown sources for career information (`profiles/cv/en/CV.MD`, `profiles/cv/ru/CV_RU.MD`).
- A TOML file mapping the Engineering Manager slug to its full title (`roles.toml`).
- A Typst template for generating PDF CVs (`templates/resume.typ`).
- A Rust application for parsing, validating, and generating all artifacts.
- No build artifacts stored in Git — all are generated by CI/CD.

---

## 2. Repository Structure

```
/
  profiles/
    cv/
      en/CV.MD
      ru/CV_RU.MD
  roles.toml
  templates/
    resume.typ
  typst/
    en/
      Belyakov_en.typ
      Belyakov_em_en.typ
    ru/
      Belyakov_ru.typ
      Belyakov_em_ru.typ
  sitegen/
    src/bin/generate.rs
    ...
  dist/
    (generated HTML and PDF artifacts)
  DOCS/
    (architecture notes, CSS, favicon)
  .github/
    workflows/
      *.yml
```

---

## 3. Application Logic

- Parse canonical CV markdown and the roles configuration for all supported languages.
- Generate light and dark PDFs per language plus optional role-specific variants, all derived from the same localized markdown sources.
- Generate a multilingual static website (`index.html`) for GitHub Pages:
  - **Main page**: shows personal info, the full career story, and a list of download links for every generated PDF.
  - **Role pages**: reuse the same rendered CV HTML while swapping PDF filenames for role-specific variants when available.
  - **Language switching**: allows seamless switching (JS, no reload) between EN/RU (or more).
- All texts, titles, and summaries are localized via the TOML files.
- Download links reference the GitHub Pages-hosted PDFs.

---

## 4. Multilanguage Support

- Every entity (markdown, roles, PDFs, pages) exists for each supported language.
- Switching language on the website is instant (JS-driven), and all UI/links update accordingly.

---

## 5. Data Handling

- Markdown and TOML files are the **single source of truth**.
- All PDFs and HTML are generated on-demand by the Rust application.
- The Typst template (`base.typ`) is versioned in the repo and can be edited without changing code.

---

## 6. CI/CD Requirements

### 6.1 On Pull Requests and Push

- **Build Rust application** (`cargo build --release`).
- **Validate all input files** (all markdown and TOML):
  - No duplicates, no missing or invalid fields.
  - Must be valid TOML/MD structure.
- **Generate all PDFs and HTML** for both languages and the Engineering Manager role:
  - All files must be created, non-empty, not broken.
- If any step fails, pipeline is red and PR is blocked.

### 6.2 On Release (Merge to main/master)

- Regenerate all PDFs and HTML as above.
- Create a GitHub Release:
  - Attach all generated PDFs.
  - Explicitly list checksums and direct links.
- Deploy to GitHub Pages (`/pages`):
  - Remove any existing published files to ensure a clean deployment.
  - Upload `index.html` and all static assets/json for frontend.
  - Site must be live at `https://<user>.github.io/cv/` and pass a basic availability check.

### 6.3 Role Variant Refresh Pipeline

- Purpose: ensure role-branded PDFs remain synchronized with the canonical CV markdown while preserving localized filenames.
- Trigger: launched by a scheduler maintained by operations and can be run manually when the CV content changes.
- Steps:
  1. Pull the latest `main` branch and run the Typst compilation matrix for every locale and role.
  2. Invoke `cargo run --release --bin generate` to rebuild HTML pages so that role URLs reuse the refreshed CV body and point to the updated PDFs.
  3. Upload the regenerated `dist/` directory to the hosting target.
- Guardrails:
  - Do not edit the canonical markdown during the pipeline; it must be a pure rebuild.
  - If any Typst compilation fails, abort and alert the maintainers with the command output.
  - Only mark the run successful when all PDFs and HTML pages are replaced atomically.

---

## 7. Example GitHub Actions Workflow

```yaml
name: Build, Test & Release CV

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Build app
        run: cargo build --release

        - name: Validate input files
          run: cargo run --release --bin validate -- validate

        - name: Generate PDFs and HTML
          run: cargo run --release --bin generate -- generate

      - name: Check generated files
        run: |
          ls dist/
          # Check all PDFs and HTML exist and are not empty

  release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Build and generate artifacts
        run: |
          cargo build --release
          cargo run --release --bin generate -- generate

      - name: Release PDFs
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.pdf

      - name: Clean previous Pages content
        run: rm -rf pages

      - name: Deploy GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          publish_dir: ./pages
          github_token: ${{ secrets.GITHUB_TOKEN }}
```

---

## 8. CLI Interface (Recommended)

  - `cargo run --release --bin validate -- validate` — Validate all data sources.
  - `cargo run --release --bin generate -- generate` — Generate all PDFs and HTML.
- (Optional) `--lang en` or `--lang ru` — restrict to a given language.

---

## 9. UX & Links

- **Main page**: shows all roles and PDF links (per language).
- **Role pages**: a single HTML template enhanced with JavaScript to insert the correct role title and language without reloading; each page provides the role-specific PDF link.
- All links point to the latest GitHub Release.

---

## 10. Sensitive Data

- Private contact info (email, phone) should be omitted or injected via CI secrets at build time (optional).

---

## 11. Extensibility

- To add new languages/roles: only add files; everything else is automated.
- Localization and frontend flexibility are “first-class.”
- No manual management of build artifacts is required.

---

**End of Spec**
