name: release-site

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_PROGRESS_WHEN: never

concurrency:
  group: release-site-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_sitegen:
    name: Build site generator and PDFs
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain and cache
        uses: ./.github/actions/setup-rust

      - name: Build sitegen binary
        shell: bash
        run: |
          set -euo pipefail
          cargo build --release --manifest-path sitegen/Cargo.toml --quiet

      - name: Build PDFs with Typst
        uses: ./.github/actions/build-pdfs

      - name: Package Typst binary
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p sitegen/target/release
          cp ~/.cargo/bin/typst sitegen/target/release/typst

      - name: Verify built PDFs (typst/)
        shell: bash
        run: |
          set -euo pipefail
          while IFS= read -r file; do
            if head -c 4 "$file" | grep -q '%PDF'; then
              echo "$(basename "$file") verified"
            else
              echo "$file is not recognized as a PDF" >&2
              exit 1
            fi
          done < <(find typst -type f -name '*.pdf')

      - name: Upload sitegen assets
        uses: actions/upload-artifact@v4
        with:
          name: sitegen-assets
          path: |
            sitegen/target/release/generate
            sitegen/target/release/typst
            typst/**/*.pdf
          overwrite: true

  site:
    name: Build site and deploy
    needs: build_sitegen
    runs-on: ubuntu-latest
    timeout-minutes: 40
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain with wasm target
        # Use a setup action that follows rust-toolchain.toml and installs
        # requested targets/components in one place.
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown
          components: clippy, rustfmt

      - name: Verify active Rust toolchain and wasm target
        shell: bash
        run: |
          set -euo pipefail
          rustc -Vv
          rustup show active-toolchain
          rustup target list --installed | grep wasm32-unknown-unknown || true

      - name: Install Trunk
        uses: jetli/trunk-action@v0.5.1
        with:
          version: v0.21.14

      - name: Download built assets
        uses: actions/download-artifact@v4
        with:
          name: sitegen-assets

      - name: Install Typst binary into PATH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p typst-bin
          mv sitegen/target/release/typst typst-bin/typst
          chmod +x typst-bin/typst
          echo "$PWD/typst-bin" >> "$GITHUB_PATH"

      - name: Prepare sitegen binary
        shell: bash
        run: |
          set -euo pipefail
          mv sitegen/target/release/generate ./sitegen_bin
          chmod +x ./sitegen_bin

      - name: Clean previous site output
        shell: bash
        run: |
          set -euo pipefail
          rm -rf docs dist

      - name: Generate site
        shell: bash
        run: |
          set -euo pipefail
          ./sitegen_bin

      - name: Preserve PDF output
        shell: bash
        run: |
          set -euo pipefail
          mv dist dist-legacy

      - name: Build wasm site
        shell: bash
        working-directory: new
        run: |
          set -euo pipefail
          trunk build --release --config Trunk.toml

      - name: Assemble site output
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist
          mv new/dist dist
          cp dist-legacy/*.pdf dist/

      - name: Verify generated PDFs (dist)
        shell: bash
        run: |
          set -euo pipefail
          while IFS= read -r file; do
            if head -c 4 "$file" | grep -q '%PDF'; then
              echo "$(basename "$file") verified"
            else
              echo "$file is not recognized as a PDF" >&2
              exit 1
            fi
          done < <(find dist -type f -name '*.pdf')

      - name: Verify site outputs
        shell: bash
        run: |
          set -euo pipefail
          test -s dist/index.html
          test -s dist/favicon.svg
          test -s dist/avatar.jpg
          pdf_count=$(find dist -maxdepth 1 -name '*.pdf' | wc -l)
          if [ "$pdf_count" -ne 8 ]; then
            echo "Expected 8 PDFs in dist but found $pdf_count" >&2
            exit 1
          fi

          wasm_count=$(find dist -type f \( -name '*.wasm' -o -name '*.wasm.gz' -o -name '*.wasm.br' \) -print | wc -l)
          js_count=$(find dist -type f \( -name '*.js' -o -name '*.js.gz' -o -name '*.js.br' \) -print | wc -l)
          css_count=$(find dist -type f \( -name '*.css' -o -name '*.css.gz' -o -name '*.css.br' \) -print | wc -l)

          if [ "$wasm_count" -lt 1 ] || [ "$js_count" -lt 1 ] || [ "$css_count" -lt 1 ]; then
            echo "Missing expected wasm/js/css assets in dist" >&2
            exit 1
          fi

      - name: Prepare Pages directory
        shell: bash
        run: |
          set -euo pipefail
          mv dist docs

      - name: Copy README_RU
        shell: bash
        run: |
          set -euo pipefail
          cp README_RU.MD docs/

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Delete previous releases
        env:
          GITHUB_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          ids=$(gh api repos/${{ github.repository }}/releases --jq '.[].id' || echo "")
          if [ -z "$ids" ]; then
            echo "No existing releases to clean up"
            exit 0
          fi

          echo "$ids" | tail -n +2 | while read -r id; do
            if [ -n "$id" ]; then
              echo "Deleting release id $id"
              gh api repos/${{ github.repository }}/releases/"$id" -X DELETE
            fi
          done

      - name: Create release with PDFs and binary
        uses: softprops/action-gh-release@v2
        with:
          tag_name: sitegen-${{ github.run_number }}
          files: |
            sitegen_bin
            typst/**/*.pdf
