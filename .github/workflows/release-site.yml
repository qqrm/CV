name: release-site

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_PROGRESS_WHEN: never

concurrency:
  group: release-site-${{ github.ref }}
  cancel-in-progress: true

jobs:
  site:
    name: Build site and deploy
    runs-on: ubuntu-latest
    timeout-minutes: 40
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Rust toolchain and cache
        uses: ./.github/actions/setup-rust

      - name: Install Rust wasm target
        shell: bash
        run: |
          set -euo pipefail
          rustup target add wasm32-unknown-unknown

      - name: Install Trunk
        uses: jetli/trunk-action@v0.5.1
        with:
          version: v0.21.14

      - name: Build PDFs with Typst
        uses: ./.github/actions/build-pdfs

      - name: Clean previous site output
        shell: bash
        run: |
          set -euo pipefail
          rm -rf docs dist

      - name: Build wasm site
        shell: bash
        run: |
          set -euo pipefail
          trunk build --release --config Trunk.toml

      - name: Assemble site output
        shell: bash
        run: |
          set -euo pipefail
          scripts/assemble_pages_dist.sh

      - name: Prepare Pages directory
        shell: bash
        run: |
          set -euo pipefail
          mv dist docs

      - name: Copy README_RU
        shell: bash
        run: |
          set -euo pipefail
          cp README_RU.MD docs/

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Delete previous releases
        env:
          GITHUB_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          ids=$(gh api repos/${{ github.repository }}/releases --jq '.[].id' || echo "")
          if [ -z "$ids" ]; then
            echo "No existing releases to clean up"
            exit 0
          fi

          echo "$ids" | tail -n +2 | while read -r id; do
            if [ -n "$id" ]; then
              echo "Deleting release id $id"
              gh api repos/${{ github.repository }}/releases/"$id" -X DELETE
            fi
          done

      - name: Create release with PDFs
        uses: softprops/action-gh-release@v2
        with:
          tag_name: site-${{ github.run_number }}
          files: |
            typst/en/Belyakov_en_light.pdf
            typst/en/Belyakov_en_dark.pdf
            typst/ru/Belyakov_ru_light.pdf
            typst/ru/Belyakov_ru_dark.pdf
            typst/en/Belyakov_rustdev_en_light.pdf
            typst/en/Belyakov_rustdev_en_dark.pdf
            typst/ru/Belyakov_rustdev_ru_light.pdf
            typst/ru/Belyakov_rustdev_ru_dark.pdf
            typst/en/Belyakov_cto_en_light.pdf
            typst/en/Belyakov_cto_en_dark.pdf
            typst/ru/Belyakov_cto_ru_light.pdf
            typst/ru/Belyakov_cto_ru_dark.pdf
