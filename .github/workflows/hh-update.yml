name: hh-update

on:
  push:
    paths:
      - CV_RU.MD
      - CV.MD
      - CV_PM_RU.MD
  schedule:
    - cron: '10 */4 * * *'

jobs:
  update:
    runs-on: ubuntu-latest
    environment: prod
    strategy:
      matrix:
        resume:
          - file: CV_RU.MD
            id_secret: RESUME_ID_RU
          - file: CV_PM_RU.MD
            id_secret: RESUME_ID_PM_RU
          - file: CV.MD
            id_secret: RESUME_ID_EN
    steps:
      - uses: actions/checkout@v3

      - name: Convert CV to JSON
        run: cargo run --manifest-path scripts/convert_cv/Cargo.toml -- ${{ matrix.resume.file }} > resume.json

      - name: Refresh access token
        run: |
          curl -X POST https://hh.ru/oauth/token \
            -d grant_type=refresh_token \
            -d client_id=${{ secrets.CLIENT_ID }} \
            -d client_secret=${{ secrets.CLIENT_SECRET }} \
            -d refresh_token=${{ secrets.REFRESH_TOKEN }} \
            -o token.json
          ACCESS_TOKEN=$(jq -r '.access_token' token.json)
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV

      - name: Upload resume to HH
        env:
          RESUME_ID: ${{ secrets[matrix.resume.id_secret] }}
        run: |
          curl -X PUT https://api.hh.ru/resumes/$RESUME_ID \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            --data @resume.json
