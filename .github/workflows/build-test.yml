name: build-test

on:
  pull_request:

permissions:
  contents: read
  actions: write

env:
  CARGO_TERM_PROGRESS_WHEN: never
  SITEGEN_MANIFEST: sitegen/Cargo.toml
  SITEGEN_TARGET: x86_64-unknown-linux-gnu

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust toolchain and cache
        uses: ./.github/actions/setup-rust

      - name: Build PDFs
        uses: ./.github/actions/build-pdfs

      - name: Build sitegen
        run: cargo build --manifest-path "$SITEGEN_MANIFEST" --target "$SITEGEN_TARGET" --quiet

      - name: Test sitegen
        run: cargo test --manifest-path "$SITEGEN_MANIFEST" --target "$SITEGEN_TARGET" --quiet

      - name: Install wasm target
        run: rustup target add wasm32-unknown-unknown

      - name: Install Trunk
        uses: jetli/trunk-action@v0.5.1
        with:
          version: v0.21.14

      - name: Build Leptos site
        run: trunk build --release --config Trunk.toml

      - name: Assemble production-like dist
        shell: bash
        run: |
          set -euo pipefail

          routed_pages=(
            "ru/index.html"
            "rust-developer/index.html"
            "rust-developer/ru/index.html"
            "cto/index.html"
            "cto/ru/index.html"
          )

          for page in "${routed_pages[@]}"; do
            mkdir -p "dist/$(dirname "$page")"
            cp dist/index.html "dist/$page"
          done

          cargo run --quiet --manifest-path "$SITEGEN_MANIFEST" --target "$SITEGEN_TARGET" --bin generate -- --out dist-assets
          cp dist-assets/*.pdf dist/
          cp dist-assets/sitemap.txt dist/sitemap.txt

      - name: Verify production-like artifacts
        shell: bash
        run: |
          set -euo pipefail

          for path in \
            dist/index.html \
            dist/ru/index.html \
            dist/rust-developer/index.html \
            dist/rust-developer/ru/index.html \
            dist/cto/index.html \
            dist/cto/ru/index.html \
            dist/favicon.svg \
            dist/avatar.jpg \
            dist/sun.svg \
            dist/moon.svg \
            dist/sitemap.txt
          do
            test -s "$path"
          done

          pdf_count=$(find dist -maxdepth 1 -name '*.pdf' | wc -l)
          if [ "$pdf_count" -ne 12 ]; then
            echo "Expected 12 PDFs in dist root, found $pdf_count" >&2
            exit 1
          fi

          wasm_count=$(find dist -type f \( -name '*.wasm' -o -name '*.wasm.gz' -o -name '*.wasm.br' \) | wc -l)
          js_count=$(find dist -type f \( -name '*.js' -o -name '*.js.gz' -o -name '*.js.br' \) | wc -l)
          css_count=$(find dist -type f \( -name '*.css' -o -name '*.css.gz' -o -name '*.css.br' \) | wc -l)

          if [ "$wasm_count" -lt 1 ] || [ "$js_count" -lt 1 ] || [ "$css_count" -lt 1 ]; then
            echo "Missing wasm/js/css assets in dist" >&2
            exit 1
          fi

          grep -q '/CV/' dist/index.html
          grep -R -n "releases/latest/download/" dist >/dev/null

      - name: Upload Typst PDFs
        uses: actions/upload-artifact@v6
        with:
          name: typst-pdfs-ci
          path: typst/**/*.pdf
          overwrite: true

  pdf-validate:
    uses: ./.github/workflows/pdf-validate.yml
