name: Collapse history to single commit

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  collapse:
    name: Collapse history
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Recreate single snapshot commit
        env:
          GIT_AUTHOR_NAME: History Collapser
          GIT_AUTHOR_EMAIL: actions@github.com
          GIT_COMMITTER_NAME: History Collapser
          GIT_COMMITTER_EMAIL: actions@github.com
        run: |
          set -euo pipefail

          if git rev-parse HEAD^ >/dev/null 2>&1; then
            echo "Current HEAD has parents; rewriting history to a single commit."
          else
            echo "Repository already reduced to a single commit; nothing to do."
            exit 0
          fi

          SNAPSHOT_MESSAGE="Snapshot: ${GITHUB_SHA}"
          TREE_SHA=$(git rev-parse HEAD^{tree})
          NEW_COMMIT=$(git commit-tree "${TREE_SHA}" -m "${SNAPSHOT_MESSAGE}")

          echo "Pushing rewritten history based on commit ${NEW_COMMIT}."
          git push origin "${NEW_COMMIT}:main" --force-with-lease
