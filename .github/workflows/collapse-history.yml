name: collapse-history

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  actions: write

concurrency:
  group: collapse-history-${{ github.ref }}
  cancel-in-progress: false

jobs:
  collapse:
    name: Collapse history to single commit
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Recreate single snapshot commit
        shell: bash
        env:
          GIT_AUTHOR_NAME: History Collapser
          GIT_AUTHOR_EMAIL: actions@github.com
          GIT_COMMITTER_NAME: History Collapser
          GIT_COMMITTER_EMAIL: actions@github.com
        run: |
          set -euo pipefail

          if git rev-parse HEAD^ >/dev/null 2>&1; then
            echo "Current HEAD has parents; rewriting history to a single commit."
          else
            echo "Repository already reduced to a single commit; nothing to do."
            exit 0
          fi

          snapshot_message="Snapshot: ${GITHUB_SHA} [skip ci]"
          tree_sha=$(git rev-parse HEAD^{tree})
          new_commit=$(git commit-tree "${tree_sha}" \
            -m "${snapshot_message}" \
            -m "skip-checks:true")

          echo "Pushing rewritten history based on commit ${new_commit}."
          git push origin "${new_commit}:main" --force-with-lease

      - name: Delete workflow run history
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          CURRENT_RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail

          echo "Deleting workflow run history for $REPO"
          deleted=0

          for page in $(seq 1 1000); do
            json="$(gh api "repos/$REPO/actions/runs?per_page=100&page=$page")"
            page_len="$(echo "$json" | jq '.workflow_runs | length')"
            if [ "$page_len" -eq 0 ]; then
              break
            fi

            ids="$(echo "$json" | jq -r '.workflow_runs[].id')"
            while IFS= read -r id; do
              [ -z "$id" ] && continue

              if [ "$id" = "$CURRENT_RUN_ID" ]; then
                echo "Skip current run $id"
                continue
              fi

              echo "DELETE run $id"
              gh api -X DELETE "repos/$REPO/actions/runs/$id" >/dev/null
              deleted=$((deleted + 1))

              if [ $((deleted % 50)) -eq 0 ]; then
                echo "Deleted so far: $deleted (sleep 2s)"
                sleep 2
              fi
            done <<< "$ids"
          done

          echo "Done. Deleted: $deleted"
